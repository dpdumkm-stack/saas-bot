<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title|default("Dashboard - Wali.ai") }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .sidebar-link {
            transition: all 0.2s;
        }

        .sidebar-link:hover {
            background-color: #e5e7eb;
            color: #1d4ed8;
        }

        .sidebar-link.active {
            background-color: #dbeafe;
            color: #1d4ed8;
            font-weight: 600;
        }
    </style>
    {% block styles %}{% endblock %}
</head>

<body class="bg-gray-50 flex h-screen overflow-hidden">

    <!-- Desktop Sidebar -->
    <aside class="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 h-full">
        <!-- Logo -->
        <div class="p-6 flex items-center gap-3 border-b border-gray-100">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
            <span class="text-xl font-bold text-gray-800">Wali.ai</span>
        </div>

        <!-- Nav -->
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <a href="{{ url_for('dashboard.index') }}"
                class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 {% if request.endpoint == 'dashboard.index' %}active{% endif %}">
                <i class="bi bi-grid-fill"></i>
                <span>Dashboard</span>
            </a>

            <a href="{{ url_for('dashboard.products') }}"
                class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 {% if request.endpoint == 'dashboard.products' %}active{% endif %}">
                <i class="bi bi-box-seam"></i>
                <span>Produk</span>
            </a>

            <a href="{{ url_for('dashboard.orders') }}"
                class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 {% if request.endpoint == 'dashboard.orders' %}active{% endif %}">
                <i class="bi bi-receipt"></i>
                <span>Pesanan</span>
            </a>

            <a href="#"
                class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 opacity-50 cursor-not-allowed"
                title="Segera Hadir">
                <i class="bi bi-people"></i>
                <span>Pelanggan</span>
            </a>

            <a href="{{ url_for('dashboard.analytics') }}"
                class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 {% if request.endpoint == 'dashboard.analytics' %}active{% endif %}">
                <i class="bi bi-bar-chart-fill"></i>
                <span>Laporan</span>
            </a>
        </nav>

        <!-- User/Footer -->
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div
                    class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">
                    {{ (toko.nama or 'T')[0] }}
                </div>
                <div class="overflow-hidden">
                    <p class="text-sm font-semibold text-gray-800 truncate">{{ toko.nama or 'Toko' }}</p>
                    <p class="text-xs text-green-600">‚óè Online</p>
                </div>
            </div>
            <a href="{{ url_for('dashboard.logout') }}"
                class="flex items-center gap-2 text-red-600 px-4 py-2 hover:bg-red-50 rounded-lg text-sm transition-colors">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Header (Mobile Menu) -->
        <header class="md:hidden bg-white border-b border-gray-200 p-4 flex justify-between items-center">
            <div class="font-bold text-gray-800">Wali.ai</div>
            <button onclick="toggleSidebar()" class="text-gray-600 focus:outline-none">
                <i class="bi bi-list text-2xl"></i>
            </button>
        </header>

        <!-- Connection Warning Banner (Hidden by default) -->
        <div id="connectionBanner" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 mx-4 mt-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="bi bi-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        Bot WhatsApp belum terhubung.
                        <a href="#" id="connectLink"
                            class="font-medium text-yellow-700 underline hover:text-yellow-600">
                            Sambungkan Sekarang
                        </a>
                        agar bot bisa membalas pesan otomatis.
                    </p>
                </div>
            </div>
        </div>

        <!-- Content Scroll Area -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Mobile Sidebar Overlay etc (Simplified for now) -->

    <script>
        function toggleSidebar() {
            // Check if mobile sidebar exists, if not maybe just alert for now or implement full mobile drawer
            alert('Menu mobile akan segera hadir. Silakan akses via Desktop untuk pengalaman terbaik.');
        }
    </script>
    <script>
        // Global Config
        window.TOKO_ID = "{{ toko.id if toko else '' }}";
        window.SESSION_NAME = "{{ toko.session_name if toko else '' }}";
        window.ORDER_ID = "{{ subscription.order_id if subscription else '' }}"; // We need to inject subscription for order_id

        // Check Connection Status
        document.addEventListener('DOMContentLoaded', async () => {
            if (!window.SESSION_NAME) return;

            try {
                const res = await fetch('/api/pairing/check-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_name: window.SESSION_NAME })
                });
                const data = await res.json();

                // Show banner if NOT working (includes FAILED, STOPPED, or unknown)
                if (data.session_status !== 'WORKING') {
                    const banner = document.getElementById('connectionBanner');
                    const link = document.getElementById('connectLink');
                    if (banner) banner.classList.remove('hidden');

                    // Build link using order_id if available, or just subscription phone
                    // The success page needs order_id to find subscription.
                    // IMPORTANT: We need subscription order_id passed to template. 
                    // In dashboard.index, 'subscription' is passed. But base.html wraps everything.
                    // Ideally we just go to /success?order_id=...
                    // If we don't have order_id handy in JS variable, we might need to fetch it or use a dedicated route.
                    // Simplest: Point to a new route /dashboard/connect that redirects to correct success page.
                    if (link) link.href = "/dashboard/connect";
                }
            } catch (e) {
                console.error("Connection check failed", e);
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>