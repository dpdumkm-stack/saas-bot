services:
  # 1. Mesin WhatsApp (WAHA)
  waha:
    image: devlikeapro/waha
    container_name: waha_service
    restart: always
    env_file:
      - waha.env
    environment:
      - WHATSAPP_DEFAULT_ENGINE=WEBJS
      - WAHA_DASHBOARD_ENABLED=false
      - WAHA_API_KEY=abc123secretkeyQM8
      # Webhook disabled to prevent crash loop (Using Polling Fallback)
      # - WAHA_WEBHOOK_URL=http://172.25.0.10:5000/webhook
      - WAHA_STORAGE=local
      - WAHA_PRINT_QR=true
      # Stability Args for Chromium in Docker
      - WAHA_PUPPETEER_ARGS=--no-sandbox --disable-dev-shm-usage --disable-gpu --disable-software-rasterizer
    ports:
      - "3000:3000"
    volumes:
      - ./waha_data:/app/.waha # Menyimpan sesi login WA agar tidak perlu scan ulang
    networks:
      saas_bot_net:

        # 2. Mesin Bot (Aplikasi Python Anda)
  bot_app:
    build: . # Mengambil instruksi dari Dockerfile di folder yang sama
    container_name: saas-bot-app
    restart: always
    command: gunicorn -w 4 -b 0.0.0.0:5000 run:app
    ports:
      - "5000:5000"
    volumes:
      # Sinkronisasi file agar data tetap aman di luar kontainer
      - ./:/app
      - ./backups:/app/backups
    environment:
      # PENTING: Ganti nilai di bawah atau gunakan file .env
      - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyC4_ty5rsP2eMfG-vafFHBEnMhZRRfK6Oo}
      - SUPER_ADMIN_WA=${SUPER_ADMIN_WA:-6281219400496}
      - SECRET_KEY=${SECRET_KEY:-}
      - WAHA_BASE_URL=http://waha:3000
      - MASTER_SESSION=${MASTER_SESSION:-default}
      - TARGET_LIMIT_USER=${TARGET_LIMIT_USER:-500}
      - WARNING_THRESHOLD=${WARNING_THRESHOLD:-450}
    depends_on:
      - waha # Memastikan WAHA nyala lebih dulu sebelum Bot
    networks:
      saas_bot_net:
        ipv4_address: 172.25.0.10

networks:
  saas_bot_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
